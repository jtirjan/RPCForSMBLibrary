/* Copyright (C) 2021 Vincent LE TOUX <vincent.letoux@gmail.com>. All rights reserved.
 * 
 * You can redistribute this program and/or modify it under the terms of
 * the GNU Lesser Public License as published by the Free Software Foundation,
 * either version 3 of the License, or (at your option) any later version.
 */
using System;
using System.Collections.Generic;
using Microsoft.VisualStudio.TestTools.UnitTesting;
using SMBLibrary.RPC;
using SMBLibrary.Services;
using Utilities;

namespace SMBLibrary.Tests
{
    [TestClass]
    public class NetlogonServiceTests
    {

        [TestMethod]
        public void DsrGetDcNameResponse()
        {
            byte[] buffer = new byte[] {0x00,0x00,0x02,0x00,0x04,0x00,0x02,0x00,0x08,0x00,0x02,0x00,0x01,0x00,0x00,0x00,
                                        0x78,0xe7,0xc0,0x10,0xe5,0x2c,0x8d,0x40,0x88,0x56,0xd8,0x11,0x9a,0xbd,0xc8,0x79,
                                        0x0c,0x00,0x02,0x00,0x10,0x00,0x02,0x00,0xfd,0x33,0x00,0xe0,0x14,0x00,0x02,0x00,
                                        0x18,0x00,0x02,0x00,0x28,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x28,0x00,0x00,0x00,
                                        0x5c,0x00,0x5c,0x00,0x57,0x00,0x49,0x00,0x4e,0x00,0x2d,0x00,0x50,0x00,0x47,0x00,
                                        0x41,0x00,0x48,0x00,0x49,0x00,0x32,0x00,0x45,0x00,0x43,0x00,0x49,0x00,0x38,0x00,
                                        0x45,0x00,0x2e,0x00,0x74,0x00,0x65,0x00,0x73,0x00,0x74,0x00,0x2e,0x00,0x6d,0x00,
                                        0x79,0x00,0x73,0x00,0x6d,0x00,0x61,0x00,0x72,0x00,0x74,0x00,0x6c,0x00,0x6f,0x00,
                                        0x67,0x00,0x6f,0x00,0x6e,0x00,0x2e,0x00,0x63,0x00,0x6f,0x00,0x6d,0x00,0x00,0x00,
                                        0x0f,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x0f,0x00,0x00,0x00,0x5c,0x00,0x5c,0x00,
                                        0x31,0x00,0x39,0x00,0x32,0x00,0x2e,0x00,0x31,0x00,0x36,0x00,0x38,0x00,0x2e,0x00,
                                        0x30,0x00,0x2e,0x00,0x32,0x00,0x35,0x00,0x00,0x00,0x00,0x00,0x16,0x00,0x00,0x00,
                                        0x00,0x00,0x00,0x00,0x16,0x00,0x00,0x00,0x74,0x00,0x65,0x00,0x73,0x00,0x74,0x00,
                                        0x2e,0x00,0x6d,0x00,0x79,0x00,0x73,0x00,0x6d,0x00,0x61,0x00,0x72,0x00,0x74,0x00,
                                        0x6c,0x00,0x6f,0x00,0x67,0x00,0x6f,0x00,0x6e,0x00,0x2e,0x00,0x63,0x00,0x6f,0x00,
                                        0x6d,0x00,0x00,0x00,0x16,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x16,0x00,0x00,0x00,
                                        0x74,0x00,0x65,0x00,0x73,0x00,0x74,0x00,0x2e,0x00,0x6d,0x00,0x79,0x00,0x73,0x00,
                                        0x6d,0x00,0x61,0x00,0x72,0x00,0x74,0x00,0x6c,0x00,0x6f,0x00,0x67,0x00,0x6f,0x00,
                                        0x6e,0x00,0x2e,0x00,0x63,0x00,0x6f,0x00,0x6d,0x00,0x00,0x00,0x18,0x00,0x00,0x00,
                                        0x00,0x00,0x00,0x00,0x18,0x00,0x00,0x00,0x44,0x00,0x65,0x00,0x66,0x00,0x61,0x00,
                                        0x75,0x00,0x6c,0x00,0x74,0x00,0x2d,0x00,0x46,0x00,0x69,0x00,0x72,0x00,0x73,0x00,
                                        0x74,0x00,0x2d,0x00,0x53,0x00,0x69,0x00,0x74,0x00,0x65,0x00,0x2d,0x00,0x4e,0x00,
                                        0x61,0x00,0x6d,0x00,0x65,0x00,0x00,0x00,0x18,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
                                        0x18,0x00,0x00,0x00,0x44,0x00,0x65,0x00,0x66,0x00,0x61,0x00,0x75,0x00,0x6c,0x00,
                                        0x74,0x00,0x2d,0x00,0x46,0x00,0x69,0x00,0x72,0x00,0x73,0x00,0x74,0x00,0x2d,0x00,
                                        0x53,0x00,0x69,0x00,0x74,0x00,0x65,0x00,0x2d,0x00,0x4e,0x00,0x61,0x00,0x6d,0x00,
                                        0x65,0x00,0x00,0x00,0x00,0x00,0x00,0x00 };

            DsrGetDcNameResponse response = new DsrGetDcNameResponse(buffer);

            Assert.IsTrue(response.DCInfo.ClientSiteName.Value == "Default-First-Site-Name");
            Assert.IsTrue(response.DCInfo.DcSiteName.Value == "Default-First-Site-Name");
            Assert.IsTrue(response.DCInfo.DnsForestName.Value == "test.mysmartlogon.com");
            Assert.IsTrue(response.DCInfo.DomainControllerAddress.Value == "\\\\192.168.0.25");
            Assert.IsTrue(response.DCInfo.DomainControllerAddressType == 1);
            Assert.IsTrue(response.DCInfo.DomainControllerName.Value == "\\\\WIN-PGAHI2ECI8E.test.mysmartlogon.com");
            Assert.IsTrue(response.DCInfo.DomainGuid.ToString() == "10c0e778-2ce5-408d-8856-d8119abdc879");
            Assert.IsTrue(response.DCInfo.DomainName.Value == "test.mysmartlogon.com");
            Assert.IsTrue(response.DCInfo.Flags == 0xe00033fd);
        }

        public void TestAll()
        {
            DsrGetDcNameResponse();
        }
    }
}
